AT_BANNER([Use case checks])

AT_SETUP([Use case 10 (1/3)])
AT_DATA([expout],
[[ 1 locking for 3 seconds
 2 locking for 3 seconds
 3 locking for 2 seconds
 1 ending
 2 ending
 3 ending
]])
AT_CHECK([flom_test_exec3.sh 1 0 3 "-r foo[[2]]" & flom_test_exec3.sh 2 1 3 "-r foo[[2]]" & flom_test_exec3.sh 3 2 2 "-r foo[[2]]"], [0], [ignore], [ignore])
AT_CLEANUP

AT_SETUP([Use case 10 (2/3)])
AT_DATA([expout],
[[ 1 locking for 3 seconds
 2 locking for 3 seconds
Resource already locked, the lock cannot be obtained
 2 ending
]])
AT_CHECK([flom_test_exec3.sh 1 0 3 "-r foo[[2]] -q 2" & flom_test_exec3.sh 2 1 3 "-r foo[[2]] -q 2 -w n" ; flom_test_exec1.sh 4 0 0 >/dev/null], [0], [ignore], [ignore])
AT_CLEANUP

AT_SETUP([Use case 10 (3/3)])
AT_DATA([expout],
[[ 1 locking for 3 seconds
 2 locking for 3 seconds
 3 locking for 2 seconds
Resource already locked, the lock cannot be obtained
 3 ending
]])
AT_CHECK([flom_test_exec3.sh 1 0 3 "-r foo[[2]]" & flom_test_exec3.sh 2 1 3 "-r foo[[2]]" & flom_test_exec3.sh 3 2 2 "-r foo[[2]] -w n" ; flom_test_exec1.sh 4 0 0 >/dev/null], [0], [ignore], [ignore])
AT_CLEANUP

AT_SETUP([Use case 11 (1/2)])
AT_DATA([expout],
[[ 1 locking for 7 seconds
 2 locking for 3 seconds
 3 locking for 3 seconds
 4 locking for 2 seconds
 2 ending
 3 ending
 4 ending
 1 ending
]])
AT_CHECK([pkill flom], [ignore], [ignore], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 7 "-t /tmp/d1 -T /tmp/c1 -l PW" & flom_test_exec3.sh 2 1 3 "-t /tmp/d2f -T /tmp/c2f -l CR -- flom -t /tmp/d2c -T /tmp/c2c -r bar[[2]]" & flom_test_exec3.sh 3 2 3 "-t /tmp/d3f -T /tmp/c3f -l CR -- flom -t /tmp/d3c -T /tmp/c3c -r bar[[2]]" & flom_test_exec3.sh 4 3 2 "-t /tmp/d4f -T /tmp/c4f -l CR -- flom -t /tmp/d4c -T /tmp/c4c -r bar[[2]]" ; flom_test_exec1.sh 5 0 0 >/dev/null], [13], [ignore], [ignore])
AT_CLEANUP

AT_SETUP([Use case 11 (2/2)])
AT_DATA([expout],
[[ 1 locking for 7 seconds
 2 locking for 3 seconds
 3 locking for 3 seconds
 4 locking for 2 seconds
Resource already locked, the lock cannot be obtained
 4 ending
 2 ending
 3 ending
 1 ending
]])
AT_CHECK([flom_test_exec3.sh 1 0 7 "-l PW" & flom_test_exec3.sh 2 1 3 "-l CR -- flom -r bar[[2]]" & flom_test_exec3.sh 3 2 3 "-l CR -- flom -r bar[[2]]" & flom_test_exec3.sh 4 3 2 "-l CR -- flom -r bar[[2]] -w n" ; flom_test_exec1.sh 5 0 0 >/dev/null], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 1])
AT_DATA([expout],
[[ 2 locking for 2 seconds
 1 locking for 1 seconds
 2 ending
 1 ending
]])
AT_CHECK([flom_test_exec1.sh 1 1 1 & flom_test_exec1.sh 2 0 2 ; flom_test_exec1.sh 3 0 0 >/dev/null], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 2])
AT_DATA([expout],
[[ 1 locking for 5 seconds
 3 locking for 3 seconds
 2 locking for 2 seconds
 4 locking for 2 seconds
 3 ending
 1 ending
 4 ending
 2 ending
]])
AT_CHECK([flom_test_exec3.sh 1 1 5 "-r R1" & flom_test_exec3.sh 2 3 2 "-r R1" & flom_test_exec3.sh 3 2 3 "-r R2" & flom_test_exec3.sh 4 4 2 "-r R2" ; flom_test_exec3.sh 5 0 0 "-r R1" >/dev/null ; flom_test_exec3.sh 6 0 0 "-r R2" >/dev/null], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 3])
AT_DATA([expout],
[[ 2 locking for 2 seconds
 1 locking for 1 seconds
Resource already locked, the lock cannot be obtained
 1 ending
 2 ending
]])
AT_CHECK([flom_test_exec3.sh 1 1 1 "-w n" & flom_test_exec1.sh 2 0 2 ; flom_test_exec1.sh 3 0 0 >/dev/null], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 4 (1/2)])
AT_DATA([expout],
[[ 2 locking for 3 seconds
 1 locking for 1 seconds
Resource already locked, the lock was not obtained because timeout (1000 milliseconds) expired
 1 ending
 2 ending
]])
AT_CHECK([flom_test_exec3.sh 1 1 1 "-o 1000" & flom_test_exec1.sh 2 0 3 ; flom_test_exec1.sh 3 0 0 >/dev/null], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 4 (2/2)])
AT_DATA([expout],
[[ 1 locking for 0 seconds
 1 ending
]])
AT_CHECK([flom_test_exec3.sh 1 0 0 "-o 1000" ; flom_test_exec1.sh 2 0 0 >/dev/null], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 5 (1/9)])
AT_DATA([expout],
[[ 1 locking for 4 seconds
 3 locking for 1 seconds
 2 locking for 1 seconds
 2 ending
 1 ending
 3 ending
]])
AT_CHECK([flom_test_exec3.sh 1 0 4 "-l PR" & flom_test_exec3.sh 2 2 1 "-l PR" & flom_test_exec3.sh 3 1 1 "-l PW" ; flom_test_exec1.sh 4 0 0 >/dev/null], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 5 (2/9)])
AT_DATA([expout],
[[ 1 locking for 2 seconds
 2 locking for 1 seconds
Resource already locked, the lock cannot be obtained
 2 ending
 1 ending
]])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l CR" & flom_test_exec3.sh 2 1 1 "-l EX -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 5 (3/9)])
AT_DATA([expout],
[[ 1 locking for 2 seconds
 2 locking for 1 seconds
Resource already locked, the lock cannot be obtained
 2 ending
 1 ending
]])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l CW" & flom_test_exec3.sh 2 1 1 "-l PR -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l CW" & flom_test_exec3.sh 2 1 1 "-l PW -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l CW" & flom_test_exec3.sh 2 1 1 "-l EX -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 5 (4/9)])
AT_DATA([expout],
[[ 1 locking for 2 seconds
 2 locking for 1 seconds
Resource already locked, the lock cannot be obtained
 2 ending
 1 ending
]])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l PR" & flom_test_exec3.sh 2 1 1 "-l CW -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l PR" & flom_test_exec3.sh 2 1 1 "-l PW -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l PR" & flom_test_exec3.sh 2 1 1 "-l EX -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 5 (5/9)])
AT_DATA([expout],
[[ 1 locking for 2 seconds
 2 locking for 1 seconds
Resource already locked, the lock cannot be obtained
 2 ending
 1 ending
]])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l PW" & flom_test_exec3.sh 2 1 1 "-l CW -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l PW" & flom_test_exec3.sh 2 1 1 "-l PR -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l PW" & flom_test_exec3.sh 2 1 1 "-l PW -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l PW" & flom_test_exec3.sh 2 1 1 "-l EX -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 5 (6/9)])
AT_DATA([expout],
[[ 1 locking for 2 seconds
 2 locking for 1 seconds
Resource already locked, the lock cannot be obtained
 2 ending
 1 ending
]])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l EX" & flom_test_exec3.sh 2 1 1 "-l CR -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l EX" & flom_test_exec3.sh 2 1 1 "-l CW -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l EX" & flom_test_exec3.sh 2 1 1 "-l PR -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l EX" & flom_test_exec3.sh 2 1 1 "-l PW -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l EX" & flom_test_exec3.sh 2 1 1 "-l EX -w n" ; flom_test_exec1.sh 3 0 0 >/dev/null ], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 5 (7/9)])
AT_DATA([expout],
[[ 1 locking for 2 seconds
 2 locking for 0 seconds
 2 ending
 1 ending
]])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l NL" & flom_test_exec3.sh 2 1 0 "-l NL" ; flom_test_exec1.sh 3 0 3 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l NL" & flom_test_exec3.sh 2 1 0 "-l CR" ; flom_test_exec1.sh 3 0 3 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l NL" & flom_test_exec3.sh 2 1 0 "-l CW" ; flom_test_exec1.sh 3 0 3 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l NL" & flom_test_exec3.sh 2 1 0 "-l PR" ; flom_test_exec1.sh 3 0 3 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l NL" & flom_test_exec3.sh 2 1 0 "-l PW" ; flom_test_exec1.sh 3 0 3 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l NL" & flom_test_exec3.sh 2 1 0 "-l EX" ; flom_test_exec1.sh 3 0 3 >/dev/null ], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 5 (8/9)])
AT_DATA([expout],
[[ 1 locking for 2 seconds
 2 locking for 0 seconds
 2 ending
 1 ending
]])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l CR" & flom_test_exec3.sh 2 1 0 "-l CR" ; flom_test_exec1.sh 3 0 3 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l CR" & flom_test_exec3.sh 2 1 0 "-l CW" ; flom_test_exec1.sh 3 0 3 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l CR" & flom_test_exec3.sh 2 1 0 "-l PR" ; flom_test_exec1.sh 3 0 3 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l CR" & flom_test_exec3.sh 2 1 0 "-l PW" ; flom_test_exec1.sh 3 0 3 >/dev/null ], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 5 (9/9)])
AT_DATA([expout],
[[ 1 locking for 2 seconds
 2 locking for 0 seconds
 2 ending
 1 ending
]])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l CW" & flom_test_exec3.sh 2 1 0 "-l CW" ; flom_test_exec1.sh 3 0 3 >/dev/null ], [0], [expout], [ignore])
AT_CHECK([flom_test_exec3.sh 1 0 2 "-l PR" & flom_test_exec3.sh 2 1 0 "-l PR" ; flom_test_exec1.sh 3 0 3 >/dev/null ], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 6 (1/2)])
AT_DATA([expout],
[[ 2 locking for 3 seconds
 1 locking for 1 seconds
Resource already locked, the lock cannot be obtained
 1 ending
 2 ending
]])
AT_CHECK([flom_test_exec3.sh 1 1 1 "-w n -s /tmp/foo" & flom_test_exec3.sh 2 0 3 "-s /tmp/foo" ; flom_test_exec3.sh 3 0 0 "-s /tmp/foo" >/dev/null], [0], [expout], [ignore])
AT_CLEANUP

AT_SETUP([Use case 6 (2/2)])
AT_DATA([expout],
[[ 2 locking for 3 seconds
 1 locking for 1 seconds
 1 ending
 2 ending
]])
AT_CHECK([flom_test_exec3.sh 1 1 1 "-w n -s /tmp/foo" & flom_test_exec3.sh 2 0 3 "-s /tmp/bar" ; flom_test_exec3.sh 3 0 0 "-s /tmp/foo" >/dev/null ; flom_test_exec3.sh 4 0 0 "-s /tmp/bar" >/dev/null], [0], [expout], [ignore])
AT_CLEANUP

